<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Items Drops | Rivengard</title>
	<style>
		:root {
			scrollbar-color: #fff1 #fff1;
			/* thumb 顏色 + track 顏色 */
			scrollbar-width: thin;
			/* 可選值：auto | thin | none */
			scrollbar-gutter: stable;
		}

		body {
			font-family: monospace;
			background-color: #333;
			color: #fff;
			font-size: 1.2em;
		}

		h1 {
			text-align: center;
		}

		figure {
			margin: 0;
		}

		figure figcaption {
			display: none;
		}

		.table {
			border-collapse: collapse;
			max-width: 100%;
			width: fit-content;
			margin: 0 auto;
			table-layout: fixed;
			display: grid;
			grid-template-columns: repeat(4, auto) repeat(10, 1fr);

			@media (max-width: 960px) {
				grid-template-columns: repeat(10, 1fr);

				.tr {
					margin-bottom: 1em;
				}

				.td:nth-of-type(1) { grid-column: span 2; }
				.td:nth-of-type(2) { grid-column: span 4; }
				.td:nth-of-type(3) { grid-column: span 2; }
				.td:nth-of-type(4) { grid-column: span 2; }
				.td:nth-of-type(5) {
					grid-column-start: 1;
					border-left-width: 1px;
				}
				.td:nth-of-type(n + 5) {
					background-color: #fff1;
				}
				.td {
					min-height: 1em;
				}
			}

			@media (max-width: 600px) {
				grid-template-columns: repeat(5, auto);

				.td:nth-of-type(2) { grid-column: span 3; }
				.td:nth-of-type(3),
				.td:nth-of-type(4) {
					display: none;
				}
				.td:nth-of-type(10) {
					border-left-width: 1px;
				}
				.td:nth-of-type(n + 10) {
					background-color: #fff2;
					text-align: right;
				}
			}
		}

		.tr {
			display: grid;
			grid-template-columns: subgrid;
			grid-column: 1 / -1;
			box-shadow: -5px -5px #0003;
			margin-bottom: .25em;
		}

		.tr.is-sticky {
			position: sticky;
			top: 0;
			background-color: #6669;
		}

		.td:nth-of-type(1) {
			text-align: center;
		}
		.td:nth-of-type(3) {
			text-transform: capitalize;
		}

		.td:nth-of-type(2) div {
			max-width: 200px;
			font-size: smaller;
		}

		.td {
			padding: 0.4em 0.5em;
			line-height: 1.5;
			border: 1px solid #ccc3;
			border-width: 0 1px 1px 0;
			place-content: center;

			&:first-child {
				border-left-width: 1px;
			}
		}

		img {
			width: 72px;
			height: 72px;
		}

		textarea {
			width: 80vw;
			height: 80vh;
			white-space: nowrap;
			background-color: inherit;
			color: inherit;
		}

		.filter {
			display: flex;
			gap: .5em;
			width: fit-content;
			margin: 0 auto 1em;
			align-items: center;
			justify-content: center;
			text-transform: capitalize;
			flex-wrap: wrap;

			hr {
				margin: 0;
			}

			& label {
				cursor: pointer;
				padding: 0.25em 0.5em;

				&:hover {
					background-color: #fff2;
				}
			}
		}

		.filter:has(input[value="common"]:checked) 		+ .table .tr:not(.is-sticky):not([data-q="common"]),
		.filter:has(input[value="uncommon"]:checked) 	+ .table .tr:not(.is-sticky):not([data-q="uncommon"]),
		.filter:has(input[value="rare"]:checked) 			+ .table .tr:not(.is-sticky):not([data-q="rare"]),
		.filter:has(input[value="epic"]:checked) 			+ .table .tr:not(.is-sticky):not([data-q="epic"]),
		.filter:has(input[value="legendary"]:checked)	+ .table .tr:not(.is-sticky):not([data-q="legendary"]) {
			display: none;
		}
		#goback {
			position: absolute;
			color: inherit;
			top: 0;
			left: 0;
			width: 3em;
			height: 3em;
			display: flex;
			padding: .25em;
			background-image: linear-gradient(135deg, #fff3 50%, #0000 50%);

			&:not(:hover) {
				opacity: .5;
			}
		}
	</style>
	<script src="./items.data.js" defer></script>
</head>

<body>
	<a href="./" id="goback" style="color: inherit;">./</a>
  <h1>
  	Items Drops | Rivengard
  	<wbr>
  </h1>
  <div id="op"></div>
</body>
<script>
window.addEventListener('DOMContentLoaded', function() {

window.data = data.filter(i => i.QUALITY !== 'HERO');

let ratios = [...new Set(data.map(i => i.RATE))]
	.filter(Boolean)
	.sort((a, b) => a - b);

// let qualitys = ['common', 'uncommon', 'rare', 'epic', 'legendary', ]
let quality_map = {
	'common': 0,
	'uncommon': 1,
	'rare': 2,
	'epic': 3,
	'legendary': 4,
}

let items = {};

data.filter(i => i.NAME).forEach(i => {
	if (!items[i.NAME]) {
		items[i.NAME] = {
			q: i.QUALITY,
			name: i.NAME,
			effect: get_effect(i),
			drops: {},
		};
	}
	if (!items[i.NAME].drops[i.RATE]) {
		items[i.NAME].drops[i.RATE] = [];
	}
	items[i.NAME].drops[i.RATE].push(`${i.Ch}-${i.MAP}`);
});

let items_arr = Object.keys(items)
	.sort((a, b) => {
		let item_a = items[a];
		let item_b = items[b];
		let _aq = quality_map[item_a.q];
		let _bq = quality_map[item_b.q];
		if (_aq === _bq) {
			return item_a.name.localeCompare(item_b.name);
		} else {
			return _aq - _bq;
		}
	})
	.map(i => items[i])

function get_effect(item) {
	return [
		'DMG',
		'HP',
		'ARMOR',
	].map(prop => {
		if (!item[prop]) { return; }
		return `${prop}+${item[prop]}`;
	}).join('');
}

function get_drops(item) {
	return ratios.map(ratio => item.drops[ratio]?.join('<br>') || '').join(' || ')
}

function capitalize(str) {
	if (!str) return '';
	return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
 }
console.log(items_arr);

function gen_wiki_table() {
	let html = `{| class="sortable fandom-table article-table" style="width: 100%;"\n! IMG !! NAME !! QUALITY !! EFFECT !! 7% !! 14% !! 20% !! 25% !! 33% !! 50% !! 60% !! 67% !! 75% !! 80%\n`;
	html += items_arr.map(i => `|-\n| [[File:${i.name}.jpg|72px|frameless|center|${i.name}]] || ${i.name} || ${capitalize(i.q)} || ${i.effect} || ${get_drops(i)}`).join('\n');
	html += `|}\n\n[[Category:Resources]]`;

	// pre.textContent = JSON.stringify(items_arr, null, 2);
	op.innerHTML = `<textarea>${html}</textarea>`;
}

function gen_table() {
	let ths = [
		'IMG',
		'NAME',
		'QUALITY',
		'EFFECT',
	].concat(ratios.map(ratio => `${ratio}%`)).map(i => `<div class="td">${i}</div>`).join('');

	let tds = items_arr.map(item => {
		let rrr = ratios.map(ratio => '<div class="td">' + (item.drops[ratio]?.join('<br>') || '') + '</div>').join('')
		return `<div class="tr" data-q="${item.q}">
			<div class="td">
        <img alt="${item.name}" src="items-drops_files/${item.name.replace(/\s/g, '_')}.webp">
			</div>
			<div class="td"><div>${item.name}</div></div>
			<div class="td">${item.q}</div>
			<div class="td">${item.effect}</div>
			${rrr}
		</div>`
	}).join('');

	op.innerHTML = `${gen_filters()}
<div class="table">
	<div class="tr is-sticky">${ths}</div>
	${tds}
</div>
	`;
	document.querySelector('.filter')?.addEventListener('input', () => {
		console.log(123);
	})
}

function gen_filters() {
	let chboxs = Object.keys(quality_map).map(i => `
			<label>
				<input type="radio" name="q" value="${i}">
				${i}
			</label>`
		).join('<hr>');
	return `<form class="filter">${chboxs}<hr><input type="reset"></form>`;
}

// gen_wiki_table();

gen_table()


});
</script>

</html>